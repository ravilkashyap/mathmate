<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Updates — Math‑Mate</title>
    <meta name="description"
        content="Updates from Math‑Mate Tuition Centre: activities, workshops, and class highlights in Yelahanka, Bengaluru." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/styles.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@600;700&display=swap"
        rel="stylesheet">
</head>

<body class="min-h-screen flex flex-col bg-white text-[#1F2937]">
    <header data-shared></header>

    <main class="flex-1 mx-auto max-w-7xl px-4 py-10">
        <div class="flex items-end justify-between gap-4">
            <h1 class="text-4xl font-bold">What’s happening at Math‑Mate</h1>
            <a class="btn-outline" href="/">← Back to Home</a>
        </div>

        <!-- Featured latest update -->
        <section id="featured" class="mt-6"></section>

        <!-- Filters -->
        <section class="mt-6 flex flex-wrap items-center gap-2">
            <span class="text-sm text-gray-600 mr-2">Filter:</span>
            <button class="btn-sm btn-outline" data-year="all">All</button>
            <div id="yearChips" class="flex flex-wrap gap-2"></div>
        </section>

        <!-- Updates grid -->
        <section id="updatesGrid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>

        <!-- Detail modal -->
        <div id="updatesModal" class="modal" aria-hidden="true">
            <div class="panel">
                <div class="close"><button type="button" aria-label="Close" data-modal-close>✕</button></div>
                <article class="p-5" id="modalContent"></article>
            </div>
        </div>
    </main>

    <footer data-shared></footer>
    <script src="../assets/js/site.js" defer></script>
    <script>
        (async function () {
            const featured = document.getElementById('featured');
            const grid = document.getElementById('updatesGrid');
            const yearChips = document.getElementById('yearChips');

            function deriveTitle(item) {
                const rawTitle = (item.title || '').trim();
                if (rawTitle && rawTitle.toLowerCase() !== 'update') return rawTitle;
                let source = (item.excerpt || item.text || '').trim();
                if (!source) return 'Math‑Mate Update';
                let candidate = source.split(/[.!?]\s|\n/)[0] || source.slice(0, 80);
                candidate = candidate.replace(/^\s*["'“”‘’]+|["'“”‘’]+\s*$/g, '');
                const tweaks = [
                    [/Visualization of\s+/i, 'Visualising '],
                    [/An Educational Trip to\s+/i, 'Visit to '],
                    [/Teaching Aids for\s+/i, 'Hands‑on '],
                    [/Trekking and Nature Exploration!?/i, 'Trek & Nature Walk'],
                    [/Fun Activities!?/i, 'Fun Activities Day'],
                    [/Visited\s+/i, 'Visit: ']
                ];
                for (const [re, rep] of tweaks) { candidate = candidate.replace(re, rep); }
                if (candidate.length > 72) candidate = candidate.slice(0, 69).replace(/\s+\S*$/, '') + '…';
                return candidate;
            }

            let res = await fetch('../assets/data/updates.json', { cache: 'no-store' });
            let updates = await res.json();
            if (!Array.isArray(updates) || !updates.length) {
                featured.innerHTML = '<div class="card p-5 text-gray-500">No updates yet.</div>';
                return;
            }

            // Normalize and sort by date desc
            updates = updates.map((u, i) => ({ ...u, _i: i, _date: Date.parse(u.date || '') || 0 })).sort((a, b) => b._date - a._date);

            // Build year filters
            const years = Array.from(new Set(updates.map(u => (u._date ? new Date(u._date).getFullYear() : 'Unknown')))).filter(Boolean).sort((a, b) => b - a);
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.className = 'btn-sm btn-outline';
                btn.dataset.year = String(y);
                btn.textContent = String(y);
                yearChips.appendChild(btn);
            });

            function render(list, year) {
                grid.innerHTML = '';
                let data = list;
                if (year && year !== 'all') {
                    data = list.filter(u => u._date && new Date(u._date).getFullYear() === Number(year));
                }
                if (!data.length) {
                    grid.innerHTML = '<div class="text-gray-500">No updates for the selected filter.</div>';
                    return;
                }
                // Featured card from first of full list when no year filter; else from first of filtered
                const first = data[0];
                if (!year || year === 'all') {
                    const img = first.image || (Array.isArray(first.media) && first.media[0]?.src) || '';
                    featured.innerHTML = `
              <article class="card p-5">
                <a href="#${first.id || ('u-' + (first._i + 1))}" class="block">
                  <div class="aspect-[16/9] w-full overflow-hidden rounded mb-3">${img ? `<img src="${img}" alt="${deriveTitle(first)}" class="w-full h-full object-cover" loading="lazy">` : ''}</div>
                  <div class="text-xs text-gray-500">${first._date ? new Date(first._date).toLocaleDateString() : ''}</div>
                  <h2 class="text-2xl font-semibold mt-1">${deriveTitle(first)}</h2>
                  ${first.text ? `<p class="mt-2 text-gray-700">${first.text}</p>` : ''}
                </a>
              </article>`;
                }

                data.forEach((u, idx) => {
                    const id = u.id || `u-${(u.title || '').slice(0, 20).replace(/[^a-z0-9]+/gi, '-').toLowerCase() || 'item'}-${idx + 1}`;
                    const img = u.image || (Array.isArray(u.media) && u.media[0]?.src) || '';
                    const card = document.createElement('article');
                    card.className = 'card p-4';
                    card.id = id;
                    card.innerHTML = `
              <a href="#${id}" class="block">
                <div class="aspect-[16/9] w-full overflow-hidden rounded mb-2">${img ? `<img src="${img}" alt="${deriveTitle(u)}" class="w-full h-full object-cover" loading="lazy">` : ''}</div>
                <div class="text-xs text-gray-500">${u._date ? new Date(u._date).toLocaleDateString() : ''}</div>
                <h3 class="font-semibold mt-1">${deriveTitle(u)}</h3>
                ${u.excerpt ? `<p class="text-sm text-gray-600 mt-1">${u.excerpt}</p>` : ''}
              </a>
              <div class="mt-3 grid sm:grid-cols-2 gap-2" data-media></div>`;
                    const mediaWrap = card.querySelector('[data-media]');
                    (u.media || []).slice(0, 4).forEach(it => {
                        if (it.type === 'video') {
                            const v = document.createElement('video'); v.src = it.src; v.controls = true; v.preload = 'metadata'; v.className = 'w-full rounded'; mediaWrap.appendChild(v);
                        } else {
                            const imgEl = document.createElement('img'); imgEl.src = it.src; imgEl.alt = `${deriveTitle(u)} — photo`; imgEl.loading = 'lazy'; imgEl.className = 'w-full rounded'; mediaWrap.appendChild(imgEl);
                        }
                    });
                    grid.appendChild(card);
                });
            }

            // Default render
            render(updates, 'all');

            // Filter interactions
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-year]');
                if (!btn) return;
                const y = btn.dataset.year;
                render(updates, y);
                // active state
                document.querySelectorAll('button[data-year]').forEach(b => b.classList.remove('ring-2'));
                btn.classList.add('ring-2');
            });

            // Anchor scroll
            if (location.hash) { const el = document.getElementById(location.hash.slice(1)); if (el) el.scrollIntoView({ behavior: 'smooth' }); }
        })();
    </script>
    <script>
        (function () {
            const modal = document.getElementById('updatesModal');
            const content = document.getElementById('modalContent');
            let data = [];

            function deriveTitle(item) {
                const rawTitle = (item.title || '').trim();
                if (rawTitle && rawTitle.toLowerCase() !== 'update') return rawTitle;
                const src = (item.excerpt || item.text || '').trim();
                if (!src) return 'Math‑Mate Update';
                let c = src.split(/[.!?]\s|\n/)[0] || src.slice(0, 80);
                c = c.replace(/^\s*["'“”‘’]+|["'“”‘’]+\s*$/g, '');
                return c.length > 72 ? c.slice(0, 69).replace(/\s+\S*$/, '') + '…' : c;
            }

            function buildCarousel(media) {
                if (!media || !media.length) return '';
                const first = media[0];
                const banner = first.type === 'video'
                    ? `<video src="${first.src}" controls preload="metadata" class="w-full rounded"></video>`
                    : `<img src="${first.src}" alt="" class="w-full rounded"/>`;
                const thumbs = media.slice(0, 12).map(m => `<img src="${m.type === 'video' ? '' : m.src}" data-src="${m.src}" alt=""/>`).join('');
                return `
            <div class="media-banner mb-3" data-carousel>
              ${banner}
            </div>
            <div class="thumb-row" data-thumbs>${thumbs}</div>
          `;
            }

            function renderModal(item) {
                const title = deriveTitle(item);
                const date = item.date ? new Date(item.date).toLocaleDateString() : '';
                const text = item.text || item.excerpt || '';
                content.innerHTML = `
            <header>
              <div class="text-xs text-gray-500">${date}</div>
              <h2 class="text-2xl font-semibold mt-1">${title}</h2>
            </header>
            <section class="mt-3">${buildCarousel(item.media || [])}</section>
            ${text ? `<p class="mt-3 text-gray-700 whitespace-pre-line">${text}</p>` : ''}
            <div class="mt-4 flex gap-2">
              <button class="btn-outline btn-sm" data-copy-link>Copy link</button>
              <a class="btn-primary btn-sm" href="#${item.id || ''}">Open on page</a>
            </div>
          `;

                // Thumbs interaction
                const thumbsWrap = content.querySelector('[data-thumbs]');
                const bannerWrap = content.querySelector('[data-carousel]');
                thumbsWrap?.addEventListener('click', (e) => {
                    const img = e.target.closest('img'); if (!img) return;
                    const src = img.getAttribute('data-src');
                    const m = (item.media || []).find(x => x.src === src);
                    if (!m) return;
                    bannerWrap.innerHTML = m.type === 'video'
                        ? `<video src="${m.src}" controls preload="metadata" class="w-full rounded"></video>`
                        : `<img src="${m.src}" alt="" class="w-full rounded"/>`;
                });

                // Copy link
                content.querySelector('[data-copy-link]')?.addEventListener('click', async () => {
                    const url = location.origin + location.pathname + '#' + (item.id || '');
                    try { await navigator.clipboard.writeText(url); } catch { }
                });
            }

            function openModalFor(id) {
                const item = data.find(u => (u.id || '') === id) || null;
                if (!item) return;
                renderModal(item);
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                if (location.hash.slice(1) !== id) { history.pushState({ u: id }, '', `#${id}`); }
            }

            function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; if (location.hash) history.replaceState(null, '', location.pathname); }
            document.addEventListener('click', (e) => { if (e.target.hasAttribute('data-modal-close')) close(); if (e.target === modal) close(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
            window.addEventListener('popstate', () => { if (!location.hash) { close(); } else { const id = location.hash.slice(1); openModalFor(id); } });

            // Hook into existing rendered cards
            window.addEventListener('load', async () => {
                try { const r = await fetch('../assets/data/updates.json', { cache: 'no-store' }); data = await r.json(); } catch { data = []; }
                document.getElementById('updatesGrid')?.addEventListener('click', (e) => {
                    const a = e.target.closest('a[href^="#"]'); if (!a) return;
                    const id = a.getAttribute('href').slice(1);
                    const item = data.find(u => (u.id || '') === id);
                    if (item) { e.preventDefault(); openModalFor(id); history.replaceState(null, '', `#${id}`); }
                });
                if (location.hash) { const id = location.hash.slice(1); openModalFor(id); }
            });
        })();
    </script>
</body>

</html>